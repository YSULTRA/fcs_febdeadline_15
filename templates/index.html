{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CryptoKnights Authentication Portal</title>
    <meta
      name="description"
      content="Secure authentication portal with multi-factor verification for CryptoKnights."
    />
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-light: #3b82f6;
        --secondary: #10b981;
        --text: #f8fafc;
        --text-secondary: #e2e8f0;
        --bg-dark: #0f172a;
        --bg-darker: #020617;
        --card-bg: rgba(15, 23, 42, 0.8);
        --card-border: rgba(148, 163, 184, 0.1);
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --input-bg: rgba(30, 41, 59, 0.5);
        --input-focus: rgba(59, 130, 246, 0.3);
        --keyboard-transition: 0.05s;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        min-height: 100vh;
        background: linear-gradient(135deg, var(--bg-darker), var(--bg-dark));
        color: var(--text);
        overflow-x: hidden;
        position: relative;
        line-height: 1.6;
      }

      .bg-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        overflow: hidden;
      }

      .bg-animation::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle at center,
          rgba(37, 99, 235, 0.1) 0%,
          transparent 70%
        );
        animation: rotate 60s linear infinite;
      }

      .bg-animation::after {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle at center,
          rgba(16, 185, 129, 0.05) 0%,
          transparent 70%
        );
        animation: rotate 40s linear infinite reverse;
      }

      @keyframes rotate {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .header {
        position: fixed;
        top: 0;
        width: 100%;
        padding: 1.5rem 5%;
        background: rgba(2, 6, 23, 0.9);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--card-border);
      }

      .header .logo {
        font-family: "Montserrat", sans-serif;
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-light);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        letter-spacing: 0.5px;
      }

      .logo-icon {
        font-size: 1.8rem;
        color: var(--primary-light);
        animation: pulse 2s infinite ease-in-out;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .nav-buttons {
        display: flex;
        gap: 1rem;
      }

      .nav-btn {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-btn:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark),
          var(--primary)
        );
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
      }

      .nav-btn i {
        font-size: 1rem;
      }

      .main-content {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 8rem 2rem 4rem;
      }

      .hero-text {
        margin-bottom: 3rem;
        text-align: center;
        max-width: 800px;
      }

      .hero-text h1 {
        font-family: "Montserrat", sans-serif;
        font-size: 3.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        background: linear-gradient(
          90deg,
          var(--primary-light),
          var(--secondary)
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        line-height: 1.2;
      }

      .hero-text p {
        font-size: 1.25rem;
        color: var(--text-secondary);
        opacity: 0.9;
      }

      .form-container {
        width: 100%;
        max-width: 500px;
        perspective: 1000px;
      }

      .form-card {
        width: 100%;
        background: var(--card-bg);
        padding: 2.5rem;
        border-radius: 1rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(12px);
        border: 1px solid var(--card-border);
        transform-style: preserve-3d;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .form-card::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          to bottom right,
          transparent 45%,
          rgba(59, 130, 246, 0.1) 50%,
          transparent 55%
        );
        transform: rotate(45deg);
        animation: shine 3s infinite;
      }

      @keyframes shine {
        0% {
          transform: translateX(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      .form-section {
        display: none;
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-section.active {
        display: block;
      }

      .form-title {
        font-family: "Montserrat", sans-serif;
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 2rem;
        color: var(--text);
        text-align: center;
        position: relative;
      }

      .form-title::after {
        content: "";
        position: absolute;
        bottom: -0.75rem;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 2px;
      }

      .form-group {
        margin-bottom: 1.5rem;
        position: relative;
      }

      .form-label {
        display: block;
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 0.75rem;
        color: var(--text-secondary);
        transition: all 0.3s ease;
      }

      .form-group:focus-within .form-label {
        color: var(--primary-light);
      }

      .form-input {
        width: 100%;
        padding: 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        background: var(--input-bg);
        color: var(--text);
        outline: none;
        transition: all 0.3s ease;
        border: 1px solid rgba(148, 163, 184, 0.2);
      }

      .form-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--input-focus);
        transform: translateY(-2px);
      }

      .otp-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--input-focus);
        background: rgba(59, 130, 246, 0.1);
      }

      .form-input::placeholder {
        color: rgba(226, 232, 240, 0.6);
      }

      .form-btn {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-dark)
        );
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .form-btn:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark),
          var(--primary)
        );
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
      }

      .form-btn:active {
        transform: translateY(0);
      }

      .form-footer {
        margin-top: 1.5rem;
        text-align: center;
        font-size: 0.95rem;
        color: var(--text-secondary);
      }

      .form-link {
        color: var(--primary-light);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .form-link:hover {
        color: var(--secondary);
        text-decoration: underline;
      }

      .virtual-keyboard {
        display: none;
        margin-top: 2rem;
        background: rgba(15, 23, 42, 0.7);
        padding: 1.5rem;
        border-radius: 0.75rem;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 0.75rem;
        border: 1px solid var(--card-border);
      }

      .virtual-keyboard.active {
        display: grid;
      }

      .keyboard-btn {
        padding: 1rem;
        font-size: 1.25rem;
        font-weight: 600;
        background: rgba(30, 41, 59, 0.8);
        color: var(--text);
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all var(--keyboard-transition) ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      .keyboard-btn:hover {
        background: rgba(51, 65, 85, 0.8);
        transform: scale(1.05);
      }

      .keyboard-btn:active {
        transform: scale(0.95);
        background: rgba(59, 130, 246, 0.8);
      }

      .keyboard-btn.clear {
        grid-column: 1 / span 1;
        background: rgba(239, 68, 68, 0.8);
      }

      .keyboard-btn.clear:hover {
        background: rgba(220, 38, 38, 0.8);
      }

      .keyboard-btn.enter {
        grid-column: 2 / span 2;
        background: rgba(16, 185, 129, 0.8);
      }

      .keyboard-btn.enter:hover {
        background: rgba(5, 150, 105, 0.8);
      }

      .status-message {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .status-message i {
        font-size: 1.25rem;
      }

      .status-success {
        background: rgba(16, 185, 129, 0.15);
        color: var(--success);
        border-left: 4px solid var(--success);
      }

      .status-warning {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warning);
        border-left: 4px solid var(--warning);
      }

      .status-error {
        background: rgba(239, 68, 68, 0.15);
        color: var(--error);
        border-left: 4px solid var(--error);
      }

      @media (max-width: 768px) {
        .header {
          padding: 1.25rem 1.5rem;
        }

        .logo {
          font-size: 1.5rem;
        }

        .nav-btn {
          padding: 0.6rem 1rem;
          font-size: 0.9rem;
        }

        .hero-text h1 {
          font-size: 2.5rem;
        }

        .hero-text p {
          font-size: 1.1rem;
        }

        .form-card {
          padding: 2rem 1.5rem;
        }

        .form-title {
          font-size: 1.75rem;
        }
      }

      @media (max-width: 480px) {
        .header {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .nav-buttons {
          width: 100%;
          justify-content: space-between;
        }

        .nav-btn {
          width: 32%;
          justify-content: center;
          padding: 0.5rem;
        }

        .hero-text h1 {
          font-size: 2rem;
        }

        .form-title {
          font-size: 1.5rem;
        }

        .form-input,
        .form-btn {
          padding: 0.85rem;
        }

        .virtual-keyboard {
          padding: 1rem;
        }

        .keyboard-btn {
          padding: 0.85rem;
          font-size: 1.1rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="bg-animation"></div>

    <div class="header">
      <div class="logo">
        <i class="fas fa-shield-alt logo-icon"></i>
        <span>CryptoKnights</span>
      </div>
      <div class="nav-buttons">
        <button class="nav-btn" onclick="showSection('register-section')">
          <i class="fas fa-user-plus"></i> Register
        </button>
        <button class="nav-btn" onclick="showSection('login-section')">
          <i class="fas fa-sign-in-alt"></i> Login
        </button>
        <button class="nav-btn" onclick="showSection('password-reset-section')">
          <i class="fas fa-key"></i> Reset
        </button>
      </div>
    </div>

    <div class="main-content">
      <div class="hero-text">
        <h1 class="animate__animated animate__fadeIn">
          Secure Authentication Portal
        </h1>
        <p class="animate__animated animate__fadeIn animate__delay-1s">
          Advanced security with multi-factor authentication for your
          CryptoKnights account
        </p>
      </div>

      <div class="form-container">
        <div
          class="form-card animate__animated animate__fadeInUp animate__delay-1s"
        >
          <div id="register-section" class="form-section active">
            <h2 class="form-title">Create Account</h2>
            <form id="register-form">
              <div class="form-group">
                <label for="reg-email" class="form-label">Email Address</label>
                <input
                  type="email"
                  id="reg-email"
                  class="form-input"
                  placeholder="your@email.com"
                  required
                />
              </div>
              <div class="form-group">
                <label for="reg-mobile" class="form-label">Mobile Number</label>
                <input
                  type="text"
                  id="reg-mobile"
                  class="form-input"
                  placeholder="+1 234 567 8900"
                  required
                />
              </div>
              <div class="form-group">
                <label for="reg-fullname" class="form-label">Full Name</label>
                <input
                  type="text"
                  id="reg-fullname"
                  class="form-input"
                  placeholder="John Doe"
                  required
                />
              </div>
              <div class="form-group">
                <label for="reg-password" class="form-label">Password</label>
                <input
                  type="password"
                  id="reg-password"
                  class="form-input"
                  placeholder="••••••••"
                  required
                />
              </div>
              <button type="submit" class="form-btn">Register Now</button>
            </form>
            <div class="form-footer">
              Already have an account?
              <span class="form-link" onclick="showSection('login-section')"
                >Sign In</span
              >
            </div>
          </div>

          <div id="login-section" class="form-section">
            <h2 class="form-title">Welcome Back</h2>
            <form id="login-form">
              <div class="form-group">
                <label for="login-email" class="form-label"
                  >Email Address</label
                >
                <input
                  type="email"
                  id="login-email"
                  class="form-input"
                  placeholder="your@email.com"
                  required
                />
              </div>
              <div class="form-group">
                <label for="login-password" class="form-label">Password</label>
                <input
                  type="password"
                  id="login-password"
                  class="form-input"
                  placeholder="••••••••"
                  required
                />
              </div>
              <button type="submit" class="form-btn">Sign In</button>
            </form>
            <div class="form-footer">
              Don't have an account?
              <span class="form-link" onclick="showSection('register-section')"
                >Register</span
              >
              or
              <span
                class="form-link"
                onclick="showSection('password-reset-section')"
                >Reset Password</span
              >
            </div>
          </div>

          <div id="password-reset-section" class="form-section">
            <h2 class="form-title">Reset Password</h2>
            <form id="password-reset-form">
              <div class="form-group">
                <label for="reset-email" class="form-label"
                  >Email Address</label
                >
                <input
                  type="email"
                  id="reset-email"
                  class="form-input"
                  placeholder="your@email.com"
                  required
                />
              </div>
              <button type="submit" class="form-btn">Request Reset</button>
            </form>
            <div class="form-footer">
              Remember your password?
              <span class="form-link" onclick="showSection('login-section')"
                >Sign In</span
              >
            </div>
          </div>

          <div id="otp-section" class="form-section">
            <h2 class="form-title">Verify Identity</h2>
            <form id="otp-form">
              <div class="form-group">
                <label for="otp-email" class="form-label">Email</label>
                <input
                  type="email"
                  id="otp-email"
                  class="form-input"
                  readonly
                  required
                />
              </div>
              <div class="form-group">
                <label for="otp-mobile" class="form-label">Mobile</label>
                <input
                  type="text"
                  id="otp-mobile"
                  class="form-input"
                  readonly
                  required
                />
              </div>
              <div class="form-group">
                <label for="email-otp" class="form-label">Email OTP</label>
                <input
                  type="text"
                  id="email-otp"
                  class="form-input otp-input"
                  placeholder="Enter 6-digit code"
                  required
                />
              </div>
              <div class="form-group">
                <label for="mobile-otp" class="form-label">Mobile OTP</label>
                <input
                  type="text"
                  id="mobile-otp"
                  class="form-input otp-input"
                  placeholder="Enter 6-digit code"
                  required
                />
              </div>
              <input
                type="hidden"
                id="otp-action"
                name="action"
                value="login"
              />
              <button type="submit" class="form-btn">Verify & Continue</button>
            </form>
            <div class="virtual-keyboard" id="virtual-keyboard">
              <button class="keyboard-btn" onclick="addDigit('1')">1</button>
              <button class="keyboard-btn" onclick="addDigit('2')">2</button>
              <button class="keyboard-btn" onclick="addDigit('3')">3</button>
              <button class="keyboard-btn" onclick="addDigit('4')">4</button>
              <button class="keyboard-btn" onclick="addDigit('5')">5</button>
              <button class="keyboard-btn" onclick="addDigit('6')">6</button>
              <button class="keyboard-btn" onclick="addDigit('7')">7</button>
              <button class="keyboard-btn" onclick="addDigit('8')">8</button>
              <button class="keyboard-btn" onclick="addDigit('9')">9</button>
              <button class="keyboard-btn clear" onclick="clearInput()">
                <i class="fas fa-backspace"></i>
              </button>
              <button class="keyboard-btn" onclick="addDigit('0')">0</button>
              <button class="keyboard-btn enter" onclick="submitForm()">
                <i class="fas fa-check"></i> Submit
              </button>
            </div>
            <div class="form-footer">
              Didn't receive codes?
              <span class="form-link" onclick="resendOTP()">Resend OTP</span>
            </div>
          </div>

          <div id="password-reset-confirm-section" class="form-section">
            <h2 class="form-title">Create New Password</h2>
            <form id="password-reset-confirm-form">
              <div class="form-group">
                <label for="reset-confirm-email" class="form-label"
                  >Email</label
                >
                <input
                  type="email"
                  id="reset-confirm-email"
                  class="form-input"
                  readonly
                  required
                />
              </div>
              <div class="form-group">
                <label for="reset-email-otp" class="form-label"
                  >Email OTP</label
                >
                <input
                  type="text"
                  id="reset-email-otp"
                  class="form-input otp-input"
                  placeholder="Enter 6-digit code"
                  required
                />
              </div>
              <div class="form-group">
                <label for="reset-mobile-otp" class="form-label"
                  >Mobile OTP</label
                >
                <input
                  type="text"
                  id="reset-mobile-otp"
                  class="form-input otp-input"
                  placeholder="Enter 6-digit code"
                  required
                />
              </div>
              <div class="form-group">
                <label for="new-password" class="form-label"
                  >New Password</label
                >
                <input
                  type="password"
                  id="new-password"
                  class="form-input"
                  placeholder="••••••••"
                  required
                />
              </div>
              <div class="form-group">
                <label for="confirm-password" class="form-label"
                  >Confirm Password</label
                >
                <input
                  type="password"
                  id="confirm-password"
                  class="form-input"
                  placeholder="••••••••"
                  required
                />
              </div>
              <button type="submit" class="form-btn">Reset Password</button>
            </form>
            <div class="virtual-keyboard" id="reset-virtual-keyboard">
              <button class="keyboard-btn" onclick="addDigit('1')">1</button>
              <button class="keyboard-btn" onclick="addDigit('2')">2</button>
              <button class="keyboard-btn" onclick="addDigit('3')">3</button>
              <button class="keyboard-btn" onclick="addDigit('4')">4</button>
              <button class="keyboard-btn" onclick="addDigit('5')">5</button>
              <button class="keyboard-btn" onclick="addDigit('6')">6</button>
              <button class="keyboard-btn" onclick="addDigit('7')">7</button>
              <button class="keyboard-btn" onclick="addDigit('8')">8</button>
              <button class="keyboard-btn" onclick="addDigit('9')">9</button>
              <button class="keyboard-btn clear" onclick="clearInput()">
                <i class="fas fa-backspace"></i>
              </button>
              <button class="keyboard-btn" onclick="addDigit('0')">0</button>
              <button class="keyboard-btn enter" onclick="submitForm()">
                <i class="fas fa-check"></i> Submit
              </button>
            </div>
          </div>

          <div id="profile-section" class="form-section">
            <h2 class="form-title">Your Profile</h2>
            <button id="fetch-profile" class="form-btn">Get Profile</button>
            <div id="profile-data"></div>
            <div class="form-footer">
              <span
                class="form-link"
                onclick="showSection('update-profile-section')"
                >Update Profile</span
              >
            </div>
          </div>

          <div id="update-profile-section" class="form-section">
            <h2 class="form-title">Update Profile</h2>
            <form id="update-profile-form">
              <div class="form-group">
                <label for="update-mobile" class="form-label"
                  >New Mobile Number</label
                >
                <input
                  type="text"
                  id="update-mobile"
                  class="form-input"
                  placeholder="New mobile number"
                />
              </div>
              <div class="form-group">
                <label for="update-name" class="form-label"
                  >New Full Name</label
                >
                <input
                  type="text"
                  id="update-name"
                  class="form-input"
                  placeholder="New full name"
                />
              </div>
              <button type="submit" class="form-btn">Update</button>
            </form>
            <div class="form-footer">
              <span class="form-link" onclick="showSection('login-section')"
                >Back to Login</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let activeInput = null;
      let lastClickTime = 0;
      const DEBOUNCE_DELAY = 100;

      function showSection(sectionId) {
        document.querySelectorAll(".form-section").forEach((section) => {
          section.classList.remove("active");
        });
        const section = document.getElementById(sectionId);
        section.classList.add("active");

        const vkb = document.getElementById("virtual-keyboard");
        const resetVkb = document.getElementById("reset-virtual-keyboard");
        vkb.style.display = sectionId === "otp-section" ? "grid" : "none";
        resetVkb.style.display = sectionId === "password-reset-confirm-section" ? "grid" : "none";

        activeInput = null;
        if (sectionId === "otp-section" || sectionId === "password-reset-confirm-section") {
          const firstOtpInput = section.querySelector(".otp-input");
          if (firstOtpInput) {
            setActiveInput(firstOtpInput);
          }
        }
      }

      function setActiveInput(input) {
        if (activeInput) {
          activeInput.classList.remove("focused");
        }
        activeInput = input;
        activeInput.classList.add("focused");
        activeInput.focus();
      }

      function addDigit(digit) {
        const currentTime = Date.now();
        if (currentTime - lastClickTime < DEBOUNCE_DELAY) return;
        lastClickTime = currentTime;

        if (!activeInput) {
          Swal.fire({
            icon: "warning",
            title: "No field selected",
            text: "Please click on an OTP field first",
          });
          return;
        }

        requestAnimationFrame(() => {
          activeInput.value += digit;
          activeInput.dispatchEvent(new Event("input", { bubbles: true }));
        });
      }

      function clearInput() {
        const currentTime = Date.now();
        if (currentTime - lastClickTime < DEBOUNCE_DELAY) return;
        lastClickTime = currentTime;

        if (!activeInput) {
          Swal.fire({
            icon: "warning",
            title: "No field selected",
            text: "Please click on an OTP field first",
          });
          return;
        }

        requestAnimationFrame(() => {
          activeInput.value = "";
          activeInput.dispatchEvent(new Event("input", { bubbles: true }));
        });
      }

      function submitForm() {
        const currentTime = Date.now();
        if (currentTime - lastClickTime < DEBOUNCE_DELAY) return;
        lastClickTime = currentTime;

        if (!activeInput) return;

        const form = activeInput.closest("form");
        if (form) {
          form.dispatchEvent(new Event("submit", {
            bubbles: true,
            cancelable: true,
          }));
        }
      }

      document.querySelectorAll(".otp-input").forEach((input) => {
        input.addEventListener("click", () => setActiveInput(input));
        input.addEventListener("focus", () => setActiveInput(input));
        input.addEventListener("touchstart", (e) => {
          e.preventDefault();
          setActiveInput(input);
        });
        input.addEventListener("input", () => {
          input.value = input.value.replace(/\D/g, "").slice(0, 6);
        });
      });

      document.querySelectorAll(".keyboard-btn").forEach((btn) => {
        const digit = btn.textContent.trim();
        const isDigit = /^\d$/.test(digit);

        btn.addEventListener("click", (e) => {
          e.preventDefault();
          if (isDigit) addDigit(digit);
        });

        btn.addEventListener("touchstart", (e) => {
          e.preventDefault();
          if (isDigit) addDigit(digit);
        });
      });

      const BASE_URL = "/users/";  // Adjusted to match your URL structure

      async function apiRequest(url, method = "GET", body = null, isFormData = false) {
        try {
          let headers = {};
          if (!isFormData) {
            headers["Content-Type"] = "application/json";
          }

          const options = {
            method,
            headers,
            credentials: "include",
          };

          if (body) {
            options.body = isFormData ? body : JSON.stringify(body);
          }

          const response = await fetch(BASE_URL + url, options);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Something went wrong");
          }

          return data;
        } catch (error) {
          console.error("API Error:", error.message);
          Swal.fire({
            icon: "error",
            title: "Error",
            text: error.message,
          });
          return null;
        }
      }

      // PKI-specific functions for signing challenges
      async function signChallenge(privateKeyPem, challenge) {
        const privateKey = await crypto.subtle.importKey(
          "pkcs8",
          pemToArrayBuffer(privateKeyPem),
          { name: "RSA-PSS", hash: "SHA-256" },
          false,
          ["sign"]
        );
        const signature = await crypto.subtle.sign(
          { name: "RSA-PSS", saltLength: 32 },
          privateKey,
          new TextEncoder().encode(challenge)
        );
        return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');
      }

      function pemToArrayBuffer(pem) {
        const b64 = pem.replace(/-----(BEGIN|END) PRIVATE KEY-----|\n/g, '');
        return Uint8Array.from(atob(b64), c => c.charCodeAt(0)).buffer;
      }

      document.getElementById("register-form").addEventListener("submit", async function (event) {
        event.preventDefault();
        const email = document.getElementById("reg-email").value.trim();
        const mobile = document.getElementById("reg-mobile").value.trim();
        const password = document.getElementById("reg-password").value.trim();
        const full_name = document.getElementById("reg-fullname").value.trim();

        if (!email || !mobile || !password || !full_name) {
          Swal.fire({
            icon: "warning",
            title: "Incomplete Form",
            text: "Please fill in all required fields.",
          });
          return;
        }

        const data = await apiRequest("register/", "POST", { email, mobile, password, full_name });
        if (data) {
          Swal.fire({
            icon: "success",
            title: "Registration Successful",
            text: data.message || "OTP sent to your email and mobile.",
          });
          document.getElementById("otp-email").value = email;
          document.getElementById("otp-mobile").value = mobile;
          document.getElementById("otp-action").value = "login";
          showSection("otp-section");
        }
      });

      document.getElementById("login-form").addEventListener("submit", async function (event) {
        event.preventDefault();
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value.trim();

        if (!email || !password) {
          Swal.fire({
            icon: "warning",
            title: "Incomplete Form",
            text: "Please enter both email and password.",
          });
          return;
        }

        // Initial login request to get the challenge
        const initialData = await apiRequest("login/", "POST", { email, password });
        if (initialData) {
          const challenge = initialData.challenge;
          const privateKeyPem = localStorage.getItem(`privateKey_${email}`);

          if (privateKeyPem && challenge) {
            try {
              const signature = await signChallenge(privateKeyPem, challenge);
              const verifyData = await apiRequest("login/", "POST", { email, password, challenge, signature });
              if (verifyData) {
                localStorage.setItem("userEmail", verifyData.user_email);
                Swal.fire({
                  icon: "success",
                  title: "Login Successful",
                  text: "Welcome back with PKI verification!",
                });
                window.location.href = "/profile/"; // Updated path
              }
            } catch (error) {
              console.error("Signature generation failed:", error);
              Swal.fire({
                icon: "error",
                title: "PKI Error",
                text: "Failed to sign challenge. Proceeding without PKI.",
              });
              proceedWithoutPKI(initialData, email);
            }
          } else {
            Swal.fire({
              icon: "warning",
              title: "PKI Not Available",
              text: "No private key found. Proceeding without PKI verification.",
            });
            proceedWithoutPKI(initialData, email);
          }
        }
      });

      function proceedWithoutPKI(initialData, email) {
        localStorage.setItem("userEmail", initialData.user_email);
        Swal.fire({
          icon: "success",
          title: "Login Successful",
          text: "Welcome back! (No PKI verification performed)",
        });
        window.location.href = "/profile/"; // Updated path
      }

      document.getElementById("password-reset-form").addEventListener("submit", async function (event) {
        event.preventDefault();
        const email = document.getElementById("reset-email").value.trim();

        if (!email) {
          Swal.fire({
            icon: "warning",
            title: "Email Required",
            text: "Please enter your email.",
          });
          return;
        }

        const data = await apiRequest("password-reset-request/", "POST", { email });
        if (data) {
          Swal.fire({
            icon: "success",
            title: "OTP Sent",
            text: data.message,
          });
          document.getElementById("reset-confirm-email").value = email;
          showSection("password-reset-confirm-section");
        }
      });

      document.getElementById("otp-form").addEventListener("submit", async function (event) {
        event.preventDefault();

        const email = document.getElementById("otp-email").value.trim();
        const mobile = document.getElementById("otp-mobile").value.trim();
        const email_otp = document.getElementById("email-otp").value.trim();
        const mobile_otp = document.getElementById("mobile-otp").value.trim();
        const action = document.getElementById("otp-action").value;

        if (!email_otp || !mobile_otp) {
          Swal.fire({
            icon: "warning",
            title: "OTP Required",
            text: "Please enter both OTPs using the virtual keyboard.",
          });
          return;
        }

        const data = await apiRequest("verify-otp/", "POST", {
          email,
          mobile,
          email_otp,
          mobile_otp,
          action,
        });

        if (data) {
          Swal.fire({
            icon: "success",
            title: "Verification Successful",
            text: data.message,
          });
          if (data.private_key) {
            localStorage.setItem(`privateKey_${email}`, data.private_key); // Store private key
          }
          showSection("login-section");
        }
      });

      document.getElementById("password-reset-confirm-form").addEventListener("submit", async function (event) {
        event.preventDefault();

        const email = document.getElementById("reset-confirm-email").value.trim();
        const email_otp = document.getElementById("reset-email-otp").value.trim();
        const mobile_otp = document.getElementById("reset-mobile-otp").value.trim();
        const new_password = document.getElementById("new-password").value.trim();
        const confirm_password = document.getElementById("confirm-password").value.trim();

        if (!email_otp || !mobile_otp || !new_password || !confirm_password) {
          Swal.fire({
            icon: "warning",
            title: "Incomplete Form",
            text: "Please fill in all fields.",
          });
          return;
        }

        if (new_password !== confirm_password) {
          Swal.fire({
            icon: "warning",
            title: "Password Mismatch",
            text: "New password and confirm password do not match.",
          });
          return;
        }

        const data = await apiRequest("password-reset-confirm/", "POST", {
          email,
          email_otp,
          mobile_otp,
          new_password,
        });

        if (data) {
          Swal.fire({
            icon: "success",
            title: "Password Reset Successful",
            text: data.message || "Your password has been updated. Please log in.",
          });
          showSection("login-section");
        }
      });

      document.getElementById("fetch-profile").addEventListener("click", async function () {
        const data = await apiRequest("profile/data/", "GET");
        if (data) {
          const profileDiv = document.getElementById("profile-data");
          profileDiv.innerHTML = `
            <p>Email: ${data.data.email}</p>
            <p>Full Name: ${data.data.full_name}</p>
            <p>Mobile: ${data.data.mobile}</p>
            <p>Username: ${data.data.username}</p>
            <p>Bio: ${data.data.bio || "Not set"}</p>
          `;
        }
      });

      document.getElementById("update-profile-form").addEventListener("submit", async function (event) {
        event.preventDefault();
        const mobile = document.getElementById("update-mobile").value.trim();
        const full_name = document.getElementById("update-name").value.trim();

        const data = await apiRequest("profile/", "PUT", { mobile, full_name });
        if (data) {
          Swal.fire({
            icon: "success",
            title: "Profile Updated",
            text: "Your profile has been updated successfully.",
          });
        }
      });

      {% if messages %}
        {% for message in messages %}
          Swal.fire({
            icon: "{{ message.tags }}",
            title: "{{ message }}",
            showConfirmButton: false,
            timer: 3000,
          });
        {% endfor %}
      {% endif %}

      function resendOTP() {
        Swal.fire({
          icon: "info",
          title: "Resending OTP",
          text: "New OTP codes have been sent to your email and mobile.",
        });
      }
    </script>
  </body>
</html>
